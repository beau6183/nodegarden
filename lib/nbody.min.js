function NBodyController_main(){var t=document.getElementById("container"),i=new NBodyController(t);i.init(),window.addEventListener("resize",i.init.bind(i))}var Box=function(){function t(t,i,e,s){this.x=t,this.y=i,this.w=e,this.h=s}return t.prototype.contains=function(t,i){return this.x<=t&&t<=this.x+this.w&&this.y<=i&&i<=this.y+this.h},t}(),Nodule=function(){function t(t,i,e,s,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===s&&(s=0),void 0===n&&(n=0),this.x=t,this.y=i,this.vx=e,this.vy=s,this._radius=0,this._mass=0,this.m=n}return Object.defineProperty(t.prototype,"m",{get:function(){return this._mass},set:function(t){t!==this._mass&&(this._mass=t,this._radius=Math.pow(3*t/(4*Math.PI),1/3))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),t}(),NBodyController=function(){function t(t){this.container=t,this.G=667408e-9,this.initialMass=10,this.criticalMass=1e4,this.exploding=0,this.canvas=document.createElement("canvas"),this.canvas.id="nodegarden",this.ctx=this.canvas.getContext("2d"),this.container.appendChild(this.canvas);var i=new Nodule;i.x=this.scaledWidth/2,i.y=this.scaledHeight/2,i.m=this.criticalMass,i.vx=0,i.vy=0,this.nodes=new Array(i)}return Object.defineProperty(t.prototype,"windowArea",{get:function(){return this.windowWidth*this.windowHeight},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pixelRatio",{get:function(){return window.devicePixelRatio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowWidth",{get:function(){return window.innerWidth},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowHeight",{get:function(){return window.innerHeight},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaledHeight",{get:function(){return this.windowHeight*this.pixelRatio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaledWidth",{get:function(){return this.windowWidth*this.pixelRatio},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.canvas.width=this.scaledWidth,this.canvas.height=this.scaledHeight,1!==this.pixelRatio&&(this.canvas.style.transform="scale("+1/this.pixelRatio+")",this.canvas.style.transformOrigin="0 0"),this.renderRequest&&window.cancelAnimationFrame(this.renderRequest),this.renderRequest=window.requestAnimationFrame(this.render.bind(this)),this.canvas.addEventListener("click",this.canvas_clickHandler.bind(this))},t.prototype.canvas_clickHandler=function(t){if(1===this.nodes.length){var i=this.nodes[0].radius,e=new Box(this.nodes[0].x-i,this.nodes[0].y-i,2*i,2*i);e.contains(t.clientX*this.pixelRatio,t.clientY*this.pixelRatio)&&this.explode()}},t.prototype.explode=function(){for(var t,i,e,s,n,a,o=this.nodes[0].radius;this.nodes[0].m>2*this.initialMass;)t=this.createNode(),s=Math.random()*o,i=Math.sqrt(Math.pow(s,2)-Math.pow(Math.random()*s,2)),e=Math.sqrt(Math.pow(s,2)-Math.pow(i,2)),n=Math.round(3*Math.random()),a={x:1,y:1},(0===n||3===n)&&(a.x=-1),(2===n||3===n)&&(a.y=-1),t.x=this.nodes[0].x+i*a.x,t.y=this.nodes[0].y+e*a.y,t.vx=i*a.x,t.vy=e*a.y,t.m=this.initialMass,t.m>this.nodes[0].m?(t.m=this.initialMass,this.nodes[0].m=this.initialMass):this.nodes[0].m-=this.initialMass,this.nodes.push(t);this.exploding=500},t.prototype.createNode=function(t){return void 0===t&&(t=null),t?(t.x=Math.random()*this.scaledWidth,t.y=Math.random()*this.scaledHeight,t.vx=1*Math.random()-.5,t.vy=1*Math.random()-.5,t.m=this.initialMass):t=new Nodule(Math.random()*this.scaledWidth,Math.random()*this.scaledHeight,1*Math.random()-.5,1*Math.random()-.5,this.initialMass),t},t.prototype.render=function(){var t,i,e,s,n,a,o,h,r,d,c,v,y,l,x;for(this.renderRequest=requestAnimationFrame(this.render.bind(this)),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.scaledWidth,this.scaledHeight),d=this.nodes.length,this.exploding&&this.exploding--,h=0;d>h;h++)for(r=d-1;r>-1;r--)if(c=this.nodes[h],v=this.nodes[r],c!==v&&c&&v){if(o={x:v.x-c.x,y:v.y-c.y},t=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),0===this.exploding&&t<c.radius+v.radius){if(c.m<=v.m){l=c.vy*(c.m/v.m),x=c.vy*(c.m/v.m),c.vx>0&&v.vx>0?c.vx>v.vx&&(v.vx+=l):c.vx<0&&v.vx<0?c.vx<v.vx&&(v.vx+=l):v.vx+=l,c.vy>0&&v.vy>0?c.vy>v.vy&&(v.vy+=x):c.vy<0&&v.vy<0?c.vy<v.vy&&(v.vy+=x):v.vy+=x,v.m+=c.m,this.nodes.splice(h,1),d=this.nodes.length,r++;continue}if(v.m<c.m){l=v.vx*(v.m/c.m),x=v.vy*(v.m/c.m),v.vx>0&&c.vx>0?v.vx>c.vx&&(c.vx+=l):v.vx<0&&c.vx<0?v.vx<c.vx&&(c.vx+=l):c.vx+=l,v.vy>0&&c.vy>0?v.vy>c.vy&&(c.vy+=x):v.vy<0&&c.vy<0?v.vy<c.vy&&(c.vy+=x):c.vy+=x,c.m+=v.m,this.nodes.splice(r,1),d=this.nodes.length,h--;continue}}s={x:o.x/t,y:o.y/t},n=this.G*(c.m*v.m/Math.pow(t,2)),isNaN(n)||(a={x:n*s.x,y:n*s.y},c.vx+=v.m/c.m*a.x,c.vy+=v.m/c.m*a.y,v.vx-=c.m/v.m*a.x,v.vy-=c.m/v.m*a.y)}for(h=0,d=this.nodes.length;d>h;h++){y=this.nodes[h],this.ctx.beginPath(),this.ctx.fillStyle="rgba("+(255-Math.floor(255*(y.m/this.criticalMass)))+", 255, 255, 1)",this.ctx.arc(y.x,y.y,y.radius,0,2*Math.PI),this.ctx.fill(),y.x+=y.vx,y.y+=y.vy;var m=y.radius;y.x-m<=0?(i=this.impactLoss(y.vx,y.vy,!0),e=1-i,y.x=m,y.vx*=-e,y.vy*=e,y.y+=y.vy):y.x+m>=this.scaledWidth&&(i=this.impactLoss(y.vx,y.vy,!0),e=1-i,y.x=this.scaledWidth-m,y.vx*=-e,y.vy*=e,y.y+=y.vy),y.y-m<=0?(i=this.impactLoss(y.vx,y.vy,!1),e=1-i,y.y=m,y.vy*=-e,y.vx*=e,y.x+=y.vx):y.y+m>=this.scaledHeight&&(i=this.impactLoss(y.vx,y.vy,!1),e=1-i,y.y=this.scaledHeight-m,y.vy*=-e,y.vx*=e,y.x+=y.vx)}},t.prototype.impactLoss=function(t,i,e){var s=Math.abs(Math.atan(i/t))*(180/Math.PI);return e&&(s=90-s),s/90},t}();